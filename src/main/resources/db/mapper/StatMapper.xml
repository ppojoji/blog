<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StatMapper">
	<select id="statDayJoinUser" resultType="CountStat">
		SELECT 
			tu.joindate  AS `range`,
		   SUM(CASE WHEN tu.`mode` = 'J' THEN 1 ELSE 0 END) AS joinCnt,
		   SUM(CASE WHEN tu.`mode` = 'D' THEN 1 ELSE 0 END) AS delCnt
		FROM tb_stat_users tu
		GROUP BY tu.joindate
	</select>
	<!-- <select id="statDayJoinUser" resultType="CountStat">
		SELECT
			DATE_FORMAT(joindate, '%Y-%m-%d') AS `range`,
			count(seq) AS cnt
		FROM tb_user
		GROUP BY DATE_FORMAT(joindate, '%Y-%m-%d')
	</select> -->
	
	<select id="statWeekJoinUser" resultType="CountStat">
		SELECT 
			DATE_FORMAT(tu.joindate,'%Y-%U') AS `range`,
		   SUM(CASE WHEN tu.`mode` = 'J' THEN 1 ELSE 0 END) AS joinCnt,
		   SUM(CASE WHEN tu.`mode` = 'D' THEN 1 ELSE 0 END) AS delCnt
		FROM tb_stat_users tu
		GROUP BY DATE_FORMAT(tu.joindate,'%Y-%U')
	</select>
	
	<select id="statMonthJoinUser" resultType="CountStat">
		SELECT 
			DATE_FORMAT(tu.joindate,'%Y-%m') AS `range`,
		   SUM(CASE WHEN tu.`mode` = 'J' THEN 1 ELSE 0 END) AS joinCnt,
		   SUM(CASE WHEN tu.`mode` = 'D' THEN 1 ELSE 0 END) AS delCnt
		FROM tb_stat_users tu
		GROUP BY DATE_FORMAT(tu.joindate,'%Y-%m')
	</select>
	<insert id="insertUserStat" parameterType="map">
		insert into tb_stat_users(
			mode,
			joindate,
			user_ref
		) values(
			#{mode},
			#{joindate},
			#{user_ref}
		) 
	</insert>
</mapper>